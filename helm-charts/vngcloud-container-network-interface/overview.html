<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Overview - vContainer Helm Infra Documentation</title>
                

        <!-- Custom HTML head -->
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

                <link rel="icon" href="../../favicon.svg">
                        <link rel="shortcut icon" href="../../favicon.png">
                <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        
        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
                <link rel="stylesheet" href="../../fonts/fonts.css">
        
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
                <link rel="stylesheet" href="../../theme/pagetoc.css">
        
                <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
            </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../../index.html">vContainer Helm Infa Repository</a></li><li class="chapter-item expanded "><a href="../../helm-charts/vcontainer-storage-interface/index.html"><strong aria-hidden="true">1.</strong> vContainer Storage Interface Chart</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../helm-charts/vcontainer-storage-interface/overview.html"><strong aria-hidden="true">1.1.</strong> Overview</a></li><li class="chapter-item expanded "><a href="../../helm-charts/vcontainer-storage-interface/installation.html"><strong aria-hidden="true">1.2.</strong> Installation</a></li><li class="chapter-item expanded "><a href="../../helm-charts/vcontainer-storage-interface/example.html"><strong aria-hidden="true">1.3.</strong> For usage</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../helm-charts/vcontainer-storage-interface/example/volume-type.html"><strong aria-hidden="true">1.3.1.</strong> StorageClass based on Volume Type</a></li><li class="chapter-item expanded "><a href="../../helm-charts/vcontainer-storage-interface/example/block-volume.html"><strong aria-hidden="true">1.3.2.</strong> Block volume</a></li><li class="chapter-item expanded "><a href="../../helm-charts/vcontainer-storage-interface/example/volume-resizing.html"><strong aria-hidden="true">1.3.3.</strong> Volume resizing</a></li><li class="chapter-item expanded "><a href="../../helm-charts/vcontainer-storage-interface/example/nfs-server.html"><strong aria-hidden="true">1.3.4.</strong> NFS server</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../../helm-charts/vngcloud-ingress-controller/index.html"><strong aria-hidden="true">2.</strong> VNGCLOUD Ingress Controller</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../helm-charts/vngcloud-ingress-controller/overview.html"><strong aria-hidden="true">2.1.</strong> Overview</a></li><li class="chapter-item expanded "><a href="../../helm-charts/vngcloud-ingress-controller/installation.html"><strong aria-hidden="true">2.2.</strong> Installation</a></li><li class="chapter-item expanded "><a href="../../helm-charts/vngcloud-ingress-controller/annotations.html"><strong aria-hidden="true">2.3.</strong> Annotations</a></li></ol></li><li class="chapter-item expanded "><a href="../../helm-charts/vngcloud-controller-manager/index.html"><strong aria-hidden="true">3.</strong> VNG Cloud Controller Manager</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../helm-charts/vngcloud-controller-manager/overview.html"><strong aria-hidden="true">3.1.</strong> Overview</a></li><li class="chapter-item expanded "><a href="../../helm-charts/vngcloud-controller-manager/installation.html"><strong aria-hidden="true">3.2.</strong> Installation</a></li><li class="chapter-item expanded "><a href="../../helm-charts/vngcloud-controller-manager/annotations.html"><strong aria-hidden="true">3.3.</strong> Annotations</a></li><li class="chapter-item expanded "><a href="../../helm-charts/vngcloud-controller-manager/example.html"><strong aria-hidden="true">3.4.</strong> For usage</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../helm-charts/vngcloud-controller-manager/example/internal-loadbalancer.html"><strong aria-hidden="true">3.4.1.</strong> Internal LoadBalancer</a></li><li class="chapter-item expanded "><a href="../../helm-charts/vngcloud-controller-manager/example/external-loadbalancer.html"><strong aria-hidden="true">3.4.2.</strong> External LoadBalancer</a></li><li class="chapter-item expanded "><a href="../../helm-charts/vngcloud-controller-manager/example/upd-server.html"><strong aria-hidden="true">3.4.3.</strong> Support UDP protocol</a></li><li class="chapter-item expanded "><a href="../../helm-charts/vngcloud-controller-manager/example/http-application.html"><strong aria-hidden="true">3.4.4.</strong> HTTP Application</a></li><li class="chapter-item expanded "><a href="../../helm-charts/vngcloud-controller-manager/example/reuse-loadbalancer.html"><strong aria-hidden="true">3.4.5.</strong> Reuse existing LoadBalancer</a></li><li class="chapter-item expanded "><a href="../../helm-charts/vngcloud-controller-manager/example/nginx-ingress.html"><strong aria-hidden="true">3.4.6.</strong> Nginx Ingress</a></li><li class="chapter-item expanded "><a href="../../helm-charts/vngcloud-controller-manager/example/change-package.html"><strong aria-hidden="true">3.4.7.</strong> Change LoadBalancer package</a></li><li class="chapter-item expanded "><a href="../../helm-charts/vngcloud-controller-manager/example/nginx-proxy.html"><strong aria-hidden="true">3.4.8.</strong> Nginx Proxy</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../../helm-charts/migrate/index.html"><strong aria-hidden="true">4.</strong> Migrate</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../helm-charts/migrate/overview.html"><strong aria-hidden="true">4.1.</strong> Overview</a></li><li class="chapter-item expanded "><a href="../../helm-charts/migrate/planning-resource.html"><strong aria-hidden="true">4.2.</strong> Planning Resources for the Target Cluster</a></li><li class="chapter-item expanded "><a href="../../helm-charts/migrate/migrate-outside-resource.html"><strong aria-hidden="true">4.3.</strong> Migrating Resources Outside a Cluster</a></li><li class="chapter-item expanded "><a href="../../helm-charts/migrate/install-tool.html"><strong aria-hidden="true">4.4.</strong> Installing the Migration Tool</a></li><li class="chapter-item expanded "><a href="../../helm-charts/migrate/migrate-resource.html"><strong aria-hidden="true">4.5.</strong> Migrating Resources in a Cluster (Velero)</a></li><li class="chapter-item expanded "><a href="../../helm-charts/migrate/update-resource.html"><strong aria-hidden="true">4.6.</strong> Updating Resources Accordingly</a></li><li class="chapter-item expanded "><a href="../../helm-charts/migrate/additional-tasks.html"><strong aria-hidden="true">4.7.</strong> Performing Additional Tasks</a></li><li class="chapter-item expanded "><a href="../../helm-charts/migrate/use-case.html"><strong aria-hidden="true">4.8.</strong> Usecase</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../helm-charts/migrate/use-case/vks-to-vks.html"><strong aria-hidden="true">4.8.1.</strong> VKS to VKS</a></li><li class="chapter-item expanded "><a href="../../helm-charts/migrate/use-case/vcontainer-to-vks.html"><strong aria-hidden="true">4.8.2.</strong> vContainer to VKS</a></li><li class="chapter-item expanded "><a href="../../helm-charts/migrate/use-case/other-to-vks.html"><strong aria-hidden="true">4.8.3.</strong> Other cloud to VKS</a></li></ol></li><li class="chapter-item expanded "><a href="../../helm-charts/migrate/more-usage.html"><strong aria-hidden="true">4.9.</strong> More usage</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../helm-charts/migrate/more-usage/prepare-velero.html"><strong aria-hidden="true">4.9.1.</strong> Prepare Velero</a></li><li class="chapter-item expanded "><a href="../../helm-charts/migrate/more-usage/deploy-sample-app.html"><strong aria-hidden="true">4.9.2.</strong> Deploy sample app</a></li><li class="chapter-item expanded "><a href="../../helm-charts/migrate/more-usage/minio.html"><strong aria-hidden="true">4.9.3.</strong> Setup Minio</a></li><li class="chapter-item expanded "><a href="../../helm-charts/migrate/more-usage/troubleshooting.html"><strong aria-hidden="true">4.9.4.</strong> Troubleshooting</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../../helm-charts/vngcloud-container-network-interface/index.html"><strong aria-hidden="true">5.</strong> CNI</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../helm-charts/vngcloud-container-network-interface/overview.html" class="active"><strong aria-hidden="true">5.1.</strong> Overview</a></li><li class="chapter-item expanded "><a href="../../helm-charts/vngcloud-container-network-interface/container-the-hardway-networking.html"><strong aria-hidden="true">5.2.</strong> Container the Hard way</a></li><li class="chapter-item expanded "><a href="../../helm-charts/vngcloud-container-network-interface/aws-network.html"><strong aria-hidden="true">5.3.</strong> AWS network</a></li><li class="chapter-item expanded "><a href="../../helm-charts/vngcloud-container-network-interface/cilium.html"><strong aria-hidden="true">5.4.</strong> Cilium</a></li><li class="chapter-item expanded "><a href="../../helm-charts/vngcloud-container-network-interface/ops-the-hardway.html"><strong aria-hidden="true">5.5.</strong> OPS the hardway</a></li><li class="chapter-item expanded "><a href="../../helm-charts/vngcloud-container-network-interface/aws-trunk.html"><strong aria-hidden="true">5.6.</strong> AWS trunk network</a></li></ol></li><li class="chapter-item expanded "><a href="../../helm-charts/vks-fleet/index.html"><strong aria-hidden="true">6.</strong> Fleet</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../helm-charts/vks-fleet/GKEVPN-strongswan.html"><strong aria-hidden="true">6.1.</strong> GKEVPN StrongSwan</a></li><li class="chapter-item expanded "><a href="../../helm-charts/vks-fleet/istio.html"><strong aria-hidden="true">6.2.</strong> Istio</a></li><li class="chapter-item expanded "><a href="../../helm-charts/vks-fleet/cert-manager-let-encrypt.html"><strong aria-hidden="true">6.3.</strong> Cert Manager + Let's Encrypt + Nginx Ingress</a></li><li class="chapter-item expanded "><a href="../../helm-charts/vks-fleet/cert-manager-let-encrypt-vngcloud.html"><strong aria-hidden="true">6.4.</strong> Cert Manager + Let's Encrypt + VNGCLOUD Ingress</a></li></ol></li><li class="chapter-item expanded "><a href="../../helm-charts/english/index.html"><strong aria-hidden="true">7.</strong> English</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../helm-charts/english/speaking.html"><strong aria-hidden="true">7.1.</strong> Speaking</a></li><li class="chapter-item expanded "><a href="../../helm-charts/english/writing_1.html"><strong aria-hidden="true">7.2.</strong> Writing task 1</a></li><li class="chapter-item expanded "><a href="../../helm-charts/english/writing.html"><strong aria-hidden="true">7.3.</strong> Writing task 2</a></li><li class="chapter-item expanded "><a href="../../helm-charts/english/vocab.html"><strong aria-hidden="true">7.4.</strong> Vocabulary</a></li></ol></li></ol>            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                                                <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                                            </div>

                    <h1 class="menu-title">vContainer Helm Infra Documentation</h1>

                    <div class="right-buttons">
                                                                        
                    </div>
                </div>

                                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <!-- Page table of contents -->
                        <div class="sidetoc"><nav class="pagetoc"></nav></div>

                        <h1 id="overview"><a class="header" href="#overview">Overview</a></h1>
<h2 id="what-is-cni"><a class="header" href="#what-is-cni">What is CNI?</a></h2>
<p><img src="https://miro.medium.com/v2/resize:fit:1050/1*gYqKRBOFfhdZW6Li63kLaw.png" alt="CNI" /></p>
<p>CNI (Container Network Interface), a Cloud Native Computing Foundation project, consists of a specification and libraries for writing plugins to configure network interfaces in Linux containers, along with a number of supported plugins. CNI concerns itself only with network connectivity of containers and removing allocated resources when the container is deleted. Because of this focus, CNI has a wide range of support and the specification is simple to implement.</p>
<h2 id="the-kubernetes-network-model"><a class="header" href="#the-kubernetes-network-model">The Kubernetes network model</a></h2>
<ul>
<li>Every Pod in a cluster gets its own unique cluster-wide IP address.</li>
<li>Kubernetes imposes the following fundamental requirements on any networking implementation
<ul>
<li>pods can communicate with all other pods on any other node without NAT</li>
<li>agents on a node (e.g. system daemons, kubelet) can communicate with all pods on that node</li>
</ul>
</li>
</ul>
<h2 id="requirements-for-our-cni"><a class="header" href="#requirements-for-our-cni">Requirements for our CNI</a></h2>
<ul>
<li>Kubernetes network model</li>
<li>Security groups for pods</li>
</ul>
<h2 id="gke"><a class="header" href="#gke">GKE</a></h2>
<p><a href="https://medium.com/cloudzone/gke-networking-options-explained-demonstrated-5c0253415eba">https://medium.com/cloudzone/gke-networking-options-explained-demonstrated-5c0253415eba</a></p>
<p>GKE currently supports two network modes: routes-based and VPC-native. The network mode defines how traffic is routed:</p>
<ul>
<li>between Kubernetes pods within the same node,</li>
<li>between nodes of the same cluster</li>
<li>other network-enabled resources on the same VPC, such as virtual machines (VMs).</li>
</ul>
<h3 id="routes-based-network-mode"><a class="header" href="#routes-based-network-mode">Routes-Based Network Mode</a></h3>
<p><img src="https://miro.medium.com/v2/resize:fit:4800/format:webp/1*aMm9g2tDiAlBXg_K8CAmHQ.png" alt="alt text" /></p>
<ul>
<li>node has a single IP address from the subnet it is launched on (10.128.0.0/20)</li>
<li>pod will also get an IP, however, is not registered in the VPC itself</li>
<li>each node reserves a /24 IP address range that is unique within the VPC and not in use by any subnet (10.0.1.0/24, 10.0.2.0/24, ... ~ 254 IP/node)</li>
<li>GKE then automatically creates a new route, using the node assigned /24 as the destination IP range and the node instance as the next hop.</li>
<li>traffic between pods on different nodes is routed through the node’s IP address</li>
</ul>
<p>Networking inside a single GKE Node
<img src="https://miro.medium.com/v2/resize:fit:720/format:webp/1*gihqRa2G_PmIOUKld4g7-w.png" alt="alt text" /></p>
<ul>
<li>each pod has a fully isolated network from the node it runs on, using Linux network namespaces</li>
<li>node connects to each of these eth0 interfaces on the pods using a virtual Ethernet (veth) device, which is always created as a pair between two network namespaces</li>
<li>all veth interfaces on the node are connected together using a Layer 2 software-defined bridge <strong>cbr0</strong></li>
</ul>
<h3 id="vpc-native-network-mode"><a class="header" href="#vpc-native-network-mode">VPC-Native Network Mode</a></h3>
<ul>
<li>This network mode uses a nifty feature called alias IP ranges</li>
<li>it is possible to have an IP range assigned to the same network interface</li>
<li>These addresses can then be assigned to applications or containers running inside the VM without requiring additional network interfaces.</li>
<li>it is possible to add one or more secondary CIDR ranges to a subnet and use subsets of them as alias IP ranges.</li>
<li>uses separate secondary address ranges for pods and Kubernetes services</li>
<li><strong>Alias IP ranges</strong>
<ul>
<li>Google Cloud alias IP ranges let you assign ranges of internal IP addresses as aliases to a virtual machine's (VM) network interfaces</li>
<li>useful if you have multiple services running on a VM and you want to assign each service a different IP address. Alias IP ranges also work with GKE Pods.</li>
<li>You can also allocate alias IP ranges from that primary range, or you can add a secondary range to the subnet and allocate alias IP ranges from secondary range</li>
</ul>
</li>
</ul>
<p><img src="https://miro.medium.com/v2/resize:fit:720/format:webp/1*JUu9Zy_Wiz5EphjGJcIYvA.png" alt="alt text" /></p>
<ul>
<li>Each Node still reserves necessary IP range for ~ 110 pods per node, a /24 is required. But smaller is ok</li>
<li>inside of a node — it is precisely the same as for clusters using the routes-based network mode</li>
<li>no need to use the custom static routes created for each GKE Node</li>
</ul>
<p>While this seems like a small difference between the two modes, it is <strong>highly advantageous</strong>.</p>
<ul>
<li>
<p>Pod IP addresses are natively routable within the cluster's VPC network and other VPC networks connected to it by VPC Network Peering.</p>
</li>
<li>
<p>Pod IP addresses are reserved in the VPC network before the Pods are created in your cluster. This prevents conflict with other resources in the VPC network and allows you to better plan IP address allocations.</p>
</li>
<li>
<p>Pod IP address ranges do not depend on custom static routes. They do not consume the system-generated and custom static routes quota. Instead, automatically-generated subnet routes handle routing for VPC-native clusters.</p>
</li>
<li>
<p>You can create firewall rules that apply to just Pod IP address ranges instead of any IP address on the cluster's nodes.</p>
</li>
<li>
<p>Pod IP address ranges, and subnet secondary IP address ranges in general, are accessible from on-premises networks connected with Cloud VPN or Cloud Interconnect using Cloud Routers.</p>
</li>
<li>
<p>Some features, such as network endpoint groups (NEGs), only work with VPC-native clusters.</p>
</li>
<li>
<p>no drawbacks to choosing a VPC-native cluster</p>
</li>
<li>
<p>firewall rules can be applied to individual pods (for routes-based clusters, the finest granularity level would have been an entire node)</p>
</li>
<li>
<p>Service (ClusterIP) addresses are only available from within the cluster. If you need to access within the cluster's VPC, create an internal Network Load Balancer.</p>
</li>
</ul>
<h2 id="aws-eks"><a class="header" href="#aws-eks">AWS EKS</a></h2>
<p><a href="https://github.com/aws/amazon-vpc-cni-k8s">Amazon VPC Container Network Interface(VPC CNI)</a></p>
<p><img src="https://aws.github.io/aws-eks-best-practices/networking/vpc-cni/image-3.png" alt="CNI" /></p>
<ul>
<li>
<p>allows Kubernetes Pods to have the same IP address as they do on the VPC network</p>
</li>
<li>
<p>all containers inside the Pod share a network namespace, and they can communicate with each-other using local ports.</p>
</li>
<li>
<p>has two components</p>
<ul>
<li>CNI Binary, which will setup Pod network to enable Pod-to-Pod communication. The CNI binary runs on a node root file system and is invoked by the kubelet when a new Pod gets added to, or an existing Pod removed from the node.</li>
<li>ipamd, a long-running node-local IP Address Management (IPAM) daemon and is responsible
<ul>
<li>managing ENIs on a node</li>
<li>maintaining a warm-pool of available IP addresses or prefix</li>
</ul>
</li>
</ul>
</li>
<li>
<p>When an instance is created, EC2 creates and attaches a primary ENI associated with a primary subnet. The Pods that run in hostNetwork mode use the primary IP address assigned to the node primary ENI and share the same network namespace as the host.</p>
</li>
</ul>
<p><img src="https://aws.github.io/aws-eks-best-practices/networking/index/image.png" alt="eks-network" /></p>
<h2 id="2024-06-25"><a class="header" href="#2024-06-25">2024-06-25</a></h2>
<h3 id="next-step"><a class="header" href="#next-step">Next-step</a></h3>
<ul>
<li><input disabled="" type="checkbox" checked=""/>
<p>benefit of secgroup, requirement, how to apply</p>
</li>
<li><input disabled="" type="checkbox"/>
<p>Network policy</p>
</li>
<li><input disabled="" type="checkbox" checked=""/>
<p>policy based routing when set <code>ip rule</code></p>
<ul>
<li>
<p>it's controls the route selection algorithm</p>
</li>
<li>
<p>Classic, routing algorithms only on the destination address of packets</p>
</li>
<li>
<p>In some circumstances, we want to route packets on other packet fields: source address, IP protocol, transport protocol, ports or even packet payload.  This task is called <code>policy routing</code>.</p>
</li>
<li>
<p>use <code>routing policy database</code> (RPDB) to solve</p>
</li>
<li>
<p>in aws</p>
<pre><code class="language-bash">10: from all iif vlan.eth.3 lookup 103
10: from all iif vlan14d01641e41 lookup 103
20: from all lookup local
512: from all to 172.31.28.221 lookup main
512: from all to 172.31.24.86 lookup main
512: from all to 172.31.18.117 lookup main
1024: from all fwmark 0x80/0x80 lookup main
32766: from all lookup main
32767: from all lookup default
</code></pre>
</li>
</ul>
</li>
<li><input disabled="" type="checkbox"/>
<p>benchmark performance of (calico+kube_proxy+iptables) vs (calico+kube_proxy+ipvs) vs (cilium+ebpf)</p>
</li>
<li><input disabled="" type="checkbox" checked=""/>
<p>why config default gateway <code>169.254.1.1</code> in network namespace and static ARP</p>
<ul>
<li>Address Resolution Protocol (ARP) is a protocol used to map IP addresses to MAC addresses. ARP is used to determine the MAC address of a device on the same network.</li>
<li>ARP table is not have entry for the default gateway, so the packet will be <code>Destination Host Unreachable</code></li>
<li>Instead, use a default gateway IP address, config a static ARP entry for the default gateway IP address.</li>
</ul>
</li>
</ul>
<h3 id="benefit-of-secgroup"><a class="header" href="#benefit-of-secgroup">Benefit of secgroup</a></h3>
<h3 id="gke-firewall-rule"><a class="header" href="#gke-firewall-rule">GKE firewall rule</a></h3>
<ul>
<li>
<p>VPC network</p>
</li>
<li>
<p>priority</p>
</li>
<li>
<p>direct traffic (ingress/egress)</p>
</li>
<li>
<p>Action on match: allow/deny</p>
</li>
<li>
<p>target</p>
<ul>
<li>all instances in the network</li>
<li>tags</li>
<li>service account</li>
</ul>
</li>
<li>
<p>source filter</p>
<ul>
<li>IP range v4 v6</li>
<li>service account</li>
<li>tag</li>
<li>SA</li>
</ul>
</li>
<li>
<p>destination filter</p>
<ul>
<li>IP range v4 v6</li>
<li>none</li>
</ul>
</li>
<li>
<p>Apply for Protocols and ports (TCP, UDP, ...)</p>
</li>
<li>
<p>tao service account tranh dynamic IP ???</p>
</li>
</ul>
<h3 id="eks"><a class="header" href="#eks">EKS</a></h3>
<h4 id="configure-security-groups-for-pods-a-hrefhttpsdocsawsamazoncomekslatestuserguidesecurity-groups-for-podshtmllinka"><a class="header" href="#configure-security-groups-for-pods-a-hrefhttpsdocsawsamazoncomekslatestuserguidesecurity-groups-for-podshtmllinka">Configure Security groups for Pods <a href="https://docs.aws.amazon.com/eks/latest/userguide/security-groups-for-pods.html">link</a></a></h4>
<ul>
<li>
<p>Enable Pod CNI: <code>ENABLE_POD_ENI=true</code></p>
</li>
<li>
<p>Create SecurityGroupPolicy CRD</p>
<pre><code class="language-yaml">apiVersion: vpcresources.k8s.aws/v1beta1
kind: SecurityGroupPolicy
metadata:
  name: my-security-group-policy
  namespace: my-namespace
spec:
  podSelector: 
    matchLabels:
      role: my-role # -----&gt; Pod Label Selector
  securityGroups:
    groupIds:
      - my_pod_security_group_id # -----&gt; Security Group ID
</code></pre>
</li>
<li>
<p>Apply for Pods</p>
<pre><code class="language-yaml">apiVersion: apps/v1
kind: Deployment
metadata:
  name: my-deployment
  namespace: my-namespace
  labels:
    app: my-app
spec:
  replicas: 4
  selector:
    matchLabels:
      app: my-app
  template:
    metadata:
      labels:
        app: my-app
        role: my-role # -----&gt; Pod Label Selector
    spec:
      terminationGracePeriodSeconds: 120
      containers:
      - name: nginx
        image: public.ecr.aws/nginx/nginx:1.23
        ports:
        - containerPort: 80
</code></pre>
</li>
</ul>
<h4 id="how-it-works-"><a class="header" href="#how-it-works-">How it works ?</a></h4>
<ul>
<li>It requires each Pod to have a unique security group =&gt; each Pod has a unique ENI
<img src="https://aws.github.io/aws-eks-best-practices/networking/sgpp/image-3.png" alt="image" /></li>
<li>Inside node:</li>
</ul>
<pre><code class="language-bash"># ip a
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 9001 qdisc mq state UP group default qlen 1000 # &lt;--- node ENI
    link/ether 0a:47:ee:98:ee:5f brd ff:ff:ff:ff:ff:ff
3: dummy0: &lt;BROADCAST,NOARP&gt; mtu 1500 qdisc noop state DOWN group default qlen 1000
    link/ether 0e:f3:c5:05:4d:65 brd ff:ff:ff:ff:ff:ff
4: pod-id-link0: &lt;BROADCAST,NOARP,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UNKNOWN group default qlen 1000
    link/ether fa:5a:38:0b:67:8c brd ff:ff:ff:ff:ff:ff
5: eni4c9bab731ed@if3: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 9001 qdisc noqueue state UP group default 
    link/ether 3a:c7:2c:0d:ca:0f brd ff:ff:ff:ff:ff:ff link-netns cni-da53182a-dd25-596a-fae3-2d0556c2692a
6: eth1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 9001 qdisc mq state UP group default qlen 1000 # &lt;--- trunk ENI
    link/ether 0a:af:27:4c:70:db brd ff:ff:ff:ff:ff:ff
7: eth2: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 9001 qdisc mq state UP group default qlen 1000
    link/ether 0a:66:21:94:e5:f1 brd ff:ff:ff:ff:ff:ff
8: eni2bc5393b053@if3: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 9001 qdisc noqueue state UP group default 
    link/ether 96:cb:92:f3:47:53 brd ff:ff:ff:ff:ff:ff link-netns cni-55ae0531-a760-9e14-a192-fdc6d6c82970
11: vlan14d01641e41@if3: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 9001 qdisc noqueue state UP group default # &lt;--- pod ENI
    link/ether a2:bc:f2:84:d3:26 brd ff:ff:ff:ff:ff:ff link-netns cni-b3466bf5-4367-e10f-09dd-99abc561194e 
12: vlan.eth.3@eth1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 9001 qdisc noqueue state UP group default qlen 1000 # &lt;--- VLAN pod ENI
    link/ether 0a:c0:2c:46:6f:33 brd ff:ff:ff:ff:ff:ff
17: eni37cc5983ec1@if3: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 9001 qdisc noqueue state UP group default 
    link/ether 1e:6e:56:e4:a5:25 brd ff:ff:ff:ff:ff:ff link-netns cni-29b37092-bcad-2228-1130-8b9945f6bb30

# ip netns
cni-29b37092-bcad-2228-1130-8b9945f6bb30 (id: 6)
cni-b3466bf5-4367-e10f-09dd-99abc561194e (id: 3) # &lt;--- pod have security group
cni-55ae0531-a760-9e14-a192-fdc6d6c82970 (id: 1)
cni-da53182a-dd25-596a-fae3-2d0556c2692a (id: 0)

# ip route # No route for pod ENI
default via 172.31.16.1 dev eth0 
169.254.169.254 dev eth0 
169.254.170.23 dev pod-id-link0 
172.31.16.0/20 dev eth0 proto kernel scope link src 172.31.17.137 
172.31.18.117 dev eni37cc5983ec1 scope link 
172.31.24.86 dev eni2bc5393b053 scope link 
172.31.28.221 dev eni4c9bab731ed scope link
</code></pre>
<table><thead><tr><th align="center">Multi port - multi NIC - multi interface</th><th align="center">multi port - trunk port</th></tr></thead><tbody>
<tr><td align="center"><img src="https://wiki.openstack.org/w/images/thumb/5/55/TrunkVnicsBefore.svg/613px-TrunkVnicsBefore.svg.png" alt="image" /></td><td align="center"><img src="https://wiki.openstack.org/w/images/thumb/7/7f/TrunkVnicsAfter.svg/653px-TrunkVnicsAfter.svg.png" alt="image" /></td></tr>
</tbody></table>
<h3 id="network-policy"><a class="header" href="#network-policy">Network policy</a></h3>
<h3 id="benchmark-performance"><a class="header" href="#benchmark-performance">Benchmark performance</a></h3>
<p><a href="https://itnext.io/benchmark-results-of-kubernetes-network-plugins-cni-over-40gbit-s-network-2024-156f085a5e4e">https://itnext.io/benchmark-results-of-kubernetes-network-plugins-cni-over-40gbit-s-network-2024-156f085a5e4e</a></p>
<ul>
<li>protocol: TCP</li>
<li>Step:
<ul>
<li>[prepare] Deployment of nodes, installation of Kubernetes, and CNI setup</li>
<li>[info] Information gathering, such as collecting MTU data of interfaces</li>
<li>[idle] Idle performance measurement to gauge the CPU and memory overhead post-CNI installation</li>
<li>[dts] Direct pod-to-pod TCP bandwidth with a Single stream</li>
<li>[dtm] Direct pod-to-pod TCP bandwidth with Multiple streams (8)</li>
<li>[dus] Direct pod-to-pod UDP bandwidth with a Single stream</li>
<li>[dum] Direct pod-to-pod UDP bandwidth with Multiple streams (8)</li>
<li>[sts] Pod to Service TCP bandwidth with a Single stream</li>
<li>[stm] Pod to Service TCP bandwidth with Multiple streams (8)</li>
<li>[sus] Pod to Service UDP bandwidth with a Single stream</li>
<li>[sum] Pod to Service UDP bandwidth with Multiple streams (8)</li>
<li>[teardown] Deinstallation of all nodes and Kubernetes cluster</li>
</ul>
</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                                                    <a rel="prev" href="../../helm-charts/vngcloud-container-network-interface/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        
                                                    <a rel="next" href="../../helm-charts/vngcloud-container-network-interface/container-the-hardway-networking.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                                    <a rel="prev" href="../../helm-charts/vngcloud-container-network-interface/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                
                                    <a rel="next" href="../../helm-charts/vngcloud-container-network-interface/container-the-hardway-networking.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                            </nav>

        </div>

        
        
        
                <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        
                <script src="../../ace.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../editor.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mode-rust.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../theme-dawn.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../theme-tomorrow_night.js" type="text/javascript" charset="utf-8"></script>
        
                <script src="../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../searcher.js" type="text/javascript" charset="utf-8"></script>
        
        <script src="../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
                <script type="text/javascript" src="../../theme/pagetoc.js"></script>
        
        
    </body>
</html>
